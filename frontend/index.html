<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Starknet PDF Signature</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            line-height: 1.6;
            color: #333;
            background-color: #f5f7fa;
        }
        h1, h2, h3 {
            color: #1a73e8;
        }
        .page-container {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 250px;
            background-color: #fff;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
            padding: 20px;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }
        .main-content {
            flex: 1;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        input[type="text"], input[type="file"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        button:hover {
            background: #1557b0;
        }
        button:disabled {
            background: #9aa0a6;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
        }
        .success {
            background-color: #e6f4ea;
            color: #137333;
        }
        .error {
            background-color: #fce8e6;
            color: #c5221f;
        }
        .info {
            background-color: #e8f0fe;
            color: #1a73e8;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .signature-details {
            margin-top: 20px;
            display: none;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1a73e8;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 2s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .wallet-section {
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        .wallet-info {
            display: flex;
            flex-direction: column;
            margin-top: 10px;
        }
        .wallet-address {
            font-family: monospace;
            background: #f5f5f5;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            word-break: break-all;
            margin-bottom: 10px;
        }
        .connect-btn {
            background: #ff5c35;
            width: 100%;
        }
        .connect-btn:hover {
            background: #e04722;
        }
        .disconnect-btn {
            background: #757575;
            width: 100%;
        }
        .disconnect-btn:hover {
            background: #616161;
        }
        .wallet-detail-item {
            margin-bottom: 8px;
            font-size: 14px;
        }
        .wallet-details h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
            color: #555;
        }
        .nav-links {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        .nav-links a {
            color: #1a73e8;
            text-decoration: none;
            padding: 10px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .nav-links a:hover {
            background-color: #f0f7ff;
        }
        .nav-links a.active {
            background-color: #e8f0fe;
            font-weight: bold;
        }
        .logo {
            text-align: center;
            margin-bottom: 20px;
        }
        .logo h2 {
            margin: 0;
            color: #1a73e8;
        }
    </style>
    <!-- Load Starknet.js -->
    <script src="https://cdn.jsdelivr.net/npm/starknet@5.14.1/dist/starknet.js"></script>
<!-- Note: Let's keep version 5.14.1 for browser as it's more compatible with wallets -->
    <script>
        // Simple check to ensure starknet.js loaded correctly
        window.addEventListener('load', function() {
            console.log('Window loaded, checking if starknet.js is available...');
            if (window.starknet) {
                console.log('✅ starknet.js loaded successfully!');
                
                // Add a global function to check starknet.js status that can be called from console
                window.checkStarknetStatus = function() {
                    console.log('StarkNet object:', window.starknet);
                    console.log('StarkNet version:', window.starknet?.version);
                    console.log('StarkNet methods:', Object.keys(window.starknet || {}).join(', '));
                    console.log('StarkNet has enable?', typeof window.starknet?.enable === 'function');
                    console.log('StarkNet has RpcProvider?', !!window.starknet?.RpcProvider);
                    return window.starknet ? 'StarkNet is loaded' : 'StarkNet is NOT loaded';
                };
                
                // Run the check automatically
                window.checkStarknetStatus();
            } else {
                console.error('❌ starknet.js did not load correctly!');
            }
        });
    </script>
</head>
<body>
    <div class="page-container">
        <!-- Left Sidebar for Wallet Connection -->
        <div class="sidebar">
            <div class="logo">
                <h2>StarkNet<br>eSign</h2>
            </div>
            
            <div class="nav-links">
                <a href="index.html" class="active">Sign Document</a>
            </div>
            
            <div class="wallet-section">
                <h3>Wallet Connection</h3>
                <p>Connect your wallet to sign documents on StarkNet.</p>
                <button id="connectWalletBtn" class="connect-btn">Connect Wallet</button>
                <div id="walletInfo" style="display: none;">
                    <div class="wallet-info">
                        <p><strong>Connected:</strong></p>
                        <span id="walletAddress" class="wallet-address"></span>
                        <button id="disconnectWalletBtn" class="disconnect-btn">Disconnect</button>
                    </div>
                    <div id="walletDetails" style="margin-top: 15px;">
                        <h3>Network Details</h3>
                        <div class="wallet-detail-item">
                            <strong>Network:</strong> <span id="walletNetwork">-</span>
                        </div>
                        <div class="wallet-detail-item">
                            <strong>Chain ID:</strong> <span id="walletChainId">-</span> 
                            <span id="walletChainIdHex" style="font-family: monospace; font-size: 0.8em; color: #666; margin-left: 5px;"></span>
                        </div>
                        <div class="wallet-detail-item">
                            <strong>Network Name:</strong> <span id="walletNetworkName" style="font-weight: 500; color: #1a73e8;">-</span>
                        </div>
                        <div class="wallet-detail-item">
                            <strong>Wallet Provider:</strong> <span id="walletProviderName">-</span>
                        </div>
                        <div class="wallet-detail-item">
                            <strong>Account Type:</strong> <span id="walletAccountType">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <h1>Sign PDF Document</h1>
            
            <div class="card">
                <h2>Sign a PDF Document</h2>
                <div class="form-group">
                    <label for="fileInput">Select PDF File</label>
                    <input type="file" id="fileInput" accept=".pdf" />
                </div>
                
                <!-- Document ID is now auto-generated by the smart contract -->
                
                <div class="form-group">
                    <label for="signatureLevel">Signature Level</label>
                    <select id="signatureLevel">
                        <option value="SES">Simple Electronic Signature (SES)</option>
                        <option value="AES">Advanced Electronic Signature (AES)</option>
                        <option value="QES">Qualified Electronic Signature (QES)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <button id="signButton" disabled>Sign Document</button>
                </div>
                
                <div id="status" class="status" style="display: none;"></div>
            </div>
            
            <div id="signatureDetails" class="card signature-details">
                <h2>Signature Details</h2>
                <div>
                    <strong>Document ID:</strong> <span id="resultDocumentId"></span>
                </div>
                <div>
                    <strong>Transaction Hash:</strong> <span id="resultTxHash"></span>
                </div>
                <div>
                    <strong>Signer Address:</strong> <span id="resultSigner"></span>
                </div>
                <div>
                    <strong>Signature Status:</strong> <span id="resultVerified"></span>
                </div>
                <div>
                    <strong>Verification Link:</strong> <a id="explorerLink" target="_blank">View on Starknet Explorer</a>
                </div>
                <div id="transactionNote" style="margin-top: 10px; padding: 10px; border-radius: 4px; background-color: #fff8e1; display: none;">
                    <strong>Note:</strong> If transaction monitoring fails due to network issues, the signature is still likely valid. 
                    You can check the status of your transaction on the explorer link above.
                </div>
            </div>
            
            <div class="card">
                <h3>How It Works</h3>
                <ol>
                    <li>Connect your wallet using the sidebar</li>
                    <li>Select your PDF document</li>
                    <li>Choose a signature level (SES, AES, or QES)</li>
                    <li>Click "Sign Document"</li>
                    <li>Confirm the transaction in your wallet</li>
                    <li>Wait for transaction confirmation</li>
                    <li>View your signature details with the auto-generated document ID</li>
                </ol>
                <p><strong>Note:</strong> This application requires a StarkNet-compatible wallet and connection to the StarkNet network.</p>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the browser-pdf-sign module (contains wallet connection and signing functionality)
        import { signPdfWithStarknet } from '../dist/browser-pdf-sign.js';
        
        // Check for existing wallet connection on page load
        document.addEventListener('DOMContentLoaded', () => {
            const isWalletConnected = localStorage.getItem('walletConnected') === 'true';
            const savedWalletAddress = localStorage.getItem('walletAddress');
            
            if (isWalletConnected && savedWalletAddress) {
                // Update UI to show connected state
                document.getElementById('walletAddress').textContent = savedWalletAddress;
                document.getElementById('walletInfo').style.display = 'block';
                document.getElementById('connectWalletBtn').style.display = 'none';
                
                // Attempt to reconnect to wallet automatically
                try {
                    if (window.starknet) {
                        console.log('Attempting to restore wallet connection from localStorage');
                        setTimeout(() => {
                            document.getElementById('connectWalletBtn').click();
                        }, 500);
                    }
                } catch (error) {
                    console.error('Error auto-reconnecting to wallet:', error);
                }
            }
        });
        
        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const signatureLevel = document.getElementById('signatureLevel');
        const signButton = document.getElementById('signButton');
        const statusDiv = document.getElementById('status');
        const signatureDetails = document.getElementById('signatureDetails');
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const disconnectWalletBtn = document.getElementById('disconnectWalletBtn');
        const walletInfo = document.getElementById('walletInfo');
        const walletAddress = document.getElementById('walletAddress');
        
        // Wallet details elements
        const walletNetwork = document.getElementById('walletNetwork');
        const walletChainId = document.getElementById('walletChainId');
        const walletChainIdHex = document.getElementById('walletChainIdHex');
        const walletNetworkName = document.getElementById('walletNetworkName');
        const walletProviderName = document.getElementById('walletProviderName');
        const walletAccountType = document.getElementById('walletAccountType');
        
        // Results Elements
        const resultDocumentId = document.getElementById('resultDocumentId');
        const resultTxHash = document.getElementById('resultTxHash');
        const resultSigner = document.getElementById('resultSigner');
        const resultVerified = document.getElementById('resultVerified');
        const explorerLink = document.getElementById('explorerLink');
        
        // Network configuration
        const NETWORK = 'sepolia'; // Set to Sepolia testnet
        const EXPLORER_URL = 'https://sepolia.voyager.online/tx/'; // Sepolia explorer URL
        
        // Store connected wallet
        let wallet = null;
        
        // Enable/disable sign button based on input and wallet connection
        function updateSignButton() {
            signButton.disabled = !wallet || !fileInput.files.length;
        }
        
        fileInput.addEventListener('change', updateSignButton);
        
        // Show status message
        function showStatus(message, type = 'info') {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }
        
        // Get and display wallet details
        async function updateWalletDetails(wallet, address) {
            try {
                console.log('Fetching wallet details for wallet object:', wallet);
                
                // Inspect wallet structure deeply for debugging
                console.log('Deep inspection of wallet properties:');
                try {
                    // Log all top-level properties
                    for (const key in wallet) {
                        console.log(`wallet.${key}:`, typeof wallet[key], wallet[key]);
                        
                        // If it's an object, log its properties too
                        if (wallet[key] && typeof wallet[key] === 'object' && !Array.isArray(wallet[key])) {
                            for (const subKey in wallet[key]) {
                                console.log(`wallet.${key}.${subKey}:`, typeof wallet[key][subKey], wallet[key][subKey]);
                            }
                        }
                    }
                } catch (err) {
                    console.error('Error during deep inspection:', err);
                }
                
                // 1. Try to determine the network/chain
                let network = 'Unknown';
                let chainId = 'Unknown';
                
                // Use the dedicated ArgentX network detection function
                const networkInfo = await detectArgentXNetwork();
                chainId = networkInfo.chainId;
                network = networkInfo.network;
                
                // If we still don't have a network, try the generic detection methods
                if (network === 'Unknown') {
                    if (wallet.provider) {
                        if (wallet.provider.chainId) {
                            chainId = wallet.provider.chainId;
                            network = getNetworkName(chainId);
                        } else if (wallet.provider.baseUrl) {
                            // Try to guess from provider URL
                            const baseUrl = wallet.provider.baseUrl;
                            if (baseUrl.includes('mainnet')) {
                                network = 'Mainnet';
                                chainId = 'mainnet-alpha';
                            } else if (baseUrl.includes('goerli') || baseUrl.includes('testnet')) {
                                network = 'Goerli Testnet';
                                chainId = 'goerli-alpha';
                            } else if (baseUrl.includes('sepolia')) {
                                network = 'Sepolia Testnet';
                                chainId = 'sepolia-alpha';
                            }
                        }
                    } else if (wallet.chainId) {
                        chainId = wallet.chainId;
                        network = getNetworkName(chainId);
                    }
                }
                
                // 2. Determine wallet provider name
                let providerName = 'Unknown';
                
                try {
                    // Direct detection based on window.starknet properties
                    if (typeof window.starknet !== 'undefined') {
                        // Check for direct provider name
                        if (window.starknet.walletName) {
                            providerName = window.starknet.walletName;
                        } 
                        // Check for Argent identifier
                        else if (window.starknet.isArgent === true) {
                            providerName = 'Argent';
                        } 
                        // Check for Braavos identifier
                        else if (window.starknet.isBraavos === true) {
                            providerName = 'Braavos';
                        }
                        // Try to use version info
                        else if (window.starknet.version) {
                            const versionStr = window.starknet.version;
                            console.log('Found StarkNet version:', versionStr);
                            
                            // Check if version string contains wallet info
                            if (versionStr.toLowerCase().includes('argent')) {
                                providerName = 'Argent';
                            } else if (versionStr.toLowerCase().includes('braavos')) {
                                providerName = 'Braavos';
                            }
                        }
                    }
                    
                    // If still unknown, try loading detection based on DOM
                    if (providerName === 'Unknown') {
                        const argentXIcon = document.querySelector('img[alt="Argent X"]');
                        const braavosIcon = document.querySelector('img[alt="Braavos"]');
                        const argentButton = document.querySelector('button[data-wallet="argentX"]');
                        const braavosButton = document.querySelector('button[data-wallet="braavos"]');
                        
                        if (argentXIcon || argentButton) {
                            providerName = 'Argent';
                        } else if (braavosIcon || braavosButton) {
                            providerName = 'Braavos';
                        }
                    }
                    
                    // If still unknown, check for wallet metadata
                    if (providerName === 'Unknown') {
                        if (wallet.id) {
                            providerName = wallet.id;
                        } else if (wallet.name) {
                            providerName = wallet.name;
                        } else if (wallet.provider && wallet.provider.name) {
                            providerName = wallet.provider.name;
                        }
                    }
                    
                    // Last resort: check if user has an ArgentX extension
                    if (providerName === 'Unknown') {
                        // If we're getting addresses but don't know the provider,
                        // it's likely the wallet integration is working correctly but
                        // we just can't identify which one it is.
                        if (Array.isArray(wallet) && wallet.length > 0) {
                            providerName = 'StarkNet Wallet';
                        }
                    }
                } catch (err) {
                    console.error('Error identifying wallet provider:', err);
                }
                
                // 3. Try to get account type
                let accountType = 'Unknown';
                try {
                    // Handle case where it's an array of addresses
                    if (Array.isArray(wallet)) {
                        // If we have connected via ArgentX, label it explicitly
                        if (window.starknet && window.starknet.isArgent) {
                            accountType = 'ArgentX Wallet';
                        } else if (window.starknet && window.starknet.isBraavos) {
                            accountType = 'Braavos Wallet';
                        } else {
                            accountType = 'Address Array';
                        }
                        
                        // Add more specific wallet type if available
                        if (window.starknet && window.starknet.account && window.starknet.account.type) {
                            accountType += ` (${window.starknet.account.type})`;
                        }
                    } else if (wallet.account && wallet.account.constructor && wallet.account.constructor.name) {
                        accountType = wallet.account.constructor.name;
                    } else if (wallet.constructor && wallet.constructor.name) {
                        accountType = wallet.constructor.name;
                    }
                    
                    // If it's ArgentX, label it explicitly
                    if (providerName === 'Argent') {
                        if (accountType === 'Unknown' || accountType === 'Object') {
                            accountType = 'ArgentX Wallet';
                        }
                    }
                    
                    // If we still don't know and starknet is available, use window.starknet type info
                    if (accountType === 'Unknown' && window.starknet) {
                        if (window.starknet.isArgent) {
                            accountType = 'ArgentX Wallet';
                        } else if (window.starknet.isBraavos) {
                            accountType = 'Braavos Wallet';
                        } else if (window.starknet.version) {
                            accountType = `StarkNet v${window.starknet.version}`;
                        }
                    }
                } catch (err) {
                    console.error('Error getting account type:', err);
                }
                
                // Balance display has been removed as requested
                
                // Decode chain ID from hex if possible
                const decodedChainId = chainId.startsWith('0x') ? decodeChainId(chainId) : null;
                
                // Get a network name that's more human readable
                const networkName = getNetworkName(chainId);
                
                // Update UI
                walletNetwork.textContent = network;
                walletChainId.textContent = chainId;
                
                // Show hex representation if it's not a hex value already
                if (walletChainIdHex) {
                    if (chainId && !chainId.startsWith('0x') && isNaN(chainId) === false) {
                        const hexValue = '0x' + Number(chainId).toString(16);
                        walletChainIdHex.textContent = `(${hexValue})`;
                    } else if (decodedChainId) {
                        walletChainIdHex.textContent = `(${decodedChainId})`;
                    }
                }
                
                // Show the network name based on the chain ID
                walletNetworkName.textContent = networkName !== chainId ? networkName : 'Unknown';
                
                walletProviderName.textContent = providerName;
                walletAccountType.textContent = accountType;
                
            } catch (error) {
                console.error('Error updating wallet details:', error);
                // Don't block the UI if we fail to get details
            }
        }
        
        // Helper to get network name from chain ID
        function getNetworkName(chainId) {
            const networks = {
                'SN_MAIN': 'Mainnet',
                'mainnet-alpha': 'Mainnet',
                'SN_GOERLI': 'Goerli Testnet',
                'goerli-alpha': 'Goerli Testnet',
                'SN_SEPOLIA': 'Sepolia Testnet',
                'sepolia-alpha': 'Sepolia Testnet',
                // Add common hex values
                '0x534e5f4d41494e': 'Mainnet (SN_MAIN)',
                '0x534e5f474f45524c49': 'Goerli Testnet (SN_GOERLI)',
                '0x534e5f5345504f4c4941': 'Sepolia Testnet (SN_SEPOLIA)'
            };
            
            return networks[chainId] || chainId;
        }
        
        // Helper function to decode hex chain ID to string
        function decodeChainId(hexChainId) {
            if (!hexChainId || !hexChainId.startsWith('0x')) return null;
            
            try {
                // Convert hex to ASCII string
                let result = '';
                for (let i = 2; i < hexChainId.length; i += 2) {
                    const hexChar = hexChainId.substr(i, 2);
                    const charCode = parseInt(hexChar, 16);
                    result += String.fromCharCode(charCode);
                }
                return result;
            } catch (err) {
                console.error('Error decoding chain ID', err);
                return null;
            }
        }
        
        // Function to detect ArgentX network (can be called directly)
        async function detectArgentXNetwork() {
            try {
                if (window.starknet && window.starknet.provider) {
                    // Method 1: Get chain ID
                    try {
                        const chainId = await window.starknet.provider.getChainId();
                        if (chainId) {
                            return {
                                chainId: chainId,
                                network: getNetworkName(chainId)
                            };
                        }
                    } catch (err) {
                        console.error('Error getting chainId:', err);
                    }
                    
                    // Method 2: Check network property
                    if (window.starknet.network) {
                        return {
                            chainId: window.starknet.network,
                            network: getNetworkName(window.starknet.network)
                        };
                    }
                    
                    // Method 3: Try to extract from provider.baseUrl
                    if (window.starknet.provider.baseUrl) {
                        const baseUrl = window.starknet.provider.baseUrl;
                        if (baseUrl.includes('mainnet')) {
                            return {
                                chainId: 'mainnet-alpha',
                                network: 'Mainnet'
                            };
                        } else if (baseUrl.includes('goerli')) {
                            return {
                                chainId: 'goerli-alpha',
                                network: 'Goerli Testnet'
                            };
                        } else if (baseUrl.includes('sepolia')) {
                            return {
                                chainId: 'sepolia-alpha',
                                network: 'Sepolia Testnet'
                            };
                        }
                    }
                }
            } catch (err) {
                console.error('Error detecting ArgentX network:', err);
            }
            
            return {
                chainId: 'Unknown',
                network: 'Unknown'
            };
        }
        
        // Balance formatting function has been removed
        
        // Connect Wallet Function - using a simplier direct approach that is more compatible with wallet providers
        connectWalletBtn.onclick = async function() {
            console.log('Connect button clicked!');
            showStatus('Connecting to wallet...', 'info');
            
            try {
                // Check if starknet.js is loaded
                if (!window.starknet) {
                    console.error('StarkNet.js is not defined in window object');
                    throw new Error('StarkNet.js library not loaded. Please check your internet connection or reload the page.');
                }
                
                // Use the simple method that works more consistently
                console.log('Trying to connect with starknet.enable()...');
                const result = await window.starknet.enable();
                console.log('Connected using starknet.enable(), result:', result);
                
                // Store the wallet result
                wallet = result;
                
                // Get the address (either the first element if array, or from account.address)
                let address;
                if (Array.isArray(result) && result.length > 0) {
                    address = result[0];
                } else if (result && result.account && result.account.address) {
                    address = result.account.address;
                } else if (result && result.selectedAddress) {
                    address = result.selectedAddress;
                } else if (window.starknet.selectedAddress) {
                    address = window.starknet.selectedAddress;
                    // In this case, we should use window.starknet as the wallet
                    wallet = window.starknet;
                }
                
                if (!address) {
                    console.error('Could not find address in wallet result:', result);
                    throw new Error('Failed to get wallet address');
                }
                
                console.log('Got wallet address:', address);
                
                // Update UI
                walletAddress.textContent = address;
                walletInfo.style.display = 'block';
                connectWalletBtn.style.display = 'none';
                
                // Save wallet connection info to localStorage
                localStorage.setItem('walletConnected', 'true');
                localStorage.setItem('walletAddress', address);
                
                // Get and display additional wallet details
                await updateWalletDetails(wallet, address);
                
                showStatus('Wallet connected successfully!', 'success');
                updateSignButton();
            } catch (error) {
                console.error('Error connecting wallet:', error);
                showStatus(`Error connecting wallet: ${error.message}`, 'error');
            }
        };
        
        // Disconnect Wallet Function
        disconnectWalletBtn.addEventListener('click', () => {
            // Reset wallet object
            wallet = null;
            
            // Update UI visibility
            walletInfo.style.display = 'none';
            connectWalletBtn.style.display = 'block'; // Show connect button again
            
            // Clear wallet details
            walletNetwork.textContent = '-';
            walletChainId.textContent = '-';
            walletProviderName.textContent = '-';
            walletAccountType.textContent = '-';
            
            // Clear localStorage
            localStorage.removeItem('walletConnected');
            localStorage.removeItem('walletAddress');
            
            updateSignButton();
            showStatus('Wallet disconnected', 'info');
        });
        
        // Reconnect functionality has been removed as requested
        
        // Sign button click handler
        signButton.addEventListener('click', async () => {
            try {
                // Check if wallet is connected
                if (!wallet) {
                    showStatus('Please connect your wallet first', 'error');
                    return;
                }
                
                // Validate inputs
                if (!fileInput.files.length) {
                    showStatus('Please select a PDF file', 'error');
                    return;
                }
                
                const file = fileInput.files[0];
                const sigLevel = signatureLevel.value;
                
                // Show loading state
                signButton.disabled = true;
                signButton.innerHTML = '<span class="loader"></span> Signing...';
                showStatus('Preparing to sign document...', 'info');
                
                // Read file as ArrayBuffer
                const arrayBuffer = await file.arrayBuffer();
                
                showStatus('Calculating document hash...', 'info');
                showStatus('Sending transaction to Starknet...', 'info');
                
                // Call the signPdfWithStarknet function with auto-generated document ID
                const result = await signPdfWithStarknet(
                    arrayBuffer,
                    sigLevel,
                    0, // Default validity period (1 year)
                    wallet
                );
                
                // Display the results
                resultDocumentId.textContent = result.document_id;
                resultTxHash.textContent = result.transaction_hash;
                resultSigner.textContent = result.signer_address;
                resultVerified.textContent = result.signature_verified ? '✅ Verified' : '❌ Failed';
                explorerLink.href = EXPLORER_URL + result.transaction_hash;
                
                // Show transaction note if there were connectivity issues
                const transactionNote = document.getElementById('transactionNote');
                if (result.monitored === false) {
                    transactionNote.style.display = 'block';
                    showStatus('Document signed, but could not monitor transaction. Check explorer for confirmation.', 'info');
                } else {
                    transactionNote.style.display = 'none';
                    showStatus('Document signed successfully!', 'success');
                }
                
                // Show signature details
                signatureDetails.style.display = 'block';
                
            } catch (error) {
                console.error('Error:', error);
                showStatus(`Error signing document: ${error.message}`, 'error');
            } finally {
                // Reset button state
                signButton.disabled = !wallet;
                signButton.textContent = 'Sign Document';
            }
        });
    </script>
</body>
</html>